{% extends 'generic/Popup.twig' %}
{% block popup_id %}category-list{% endblock %}
{% block title %}Categories{% endblock %}
{% block body %}

<input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <span class="float-right">
        <input id="new_category_text" placeholder="New Category" rows="1" type="text" name="new_category" id="new_category" maxlength="50" onkeyup="checkInputMaxLength($(this))" />
        <button type="button" title="Add new category" onclick="addNewCategory('{{ csrf_token }}');" style="margin-left:10px;" class="btn btn-primary btn-sm">

            <i class="fas fa-plus-circle fa-1x"></i> Add category
        </button>
    </span>
    <pre>(Drag to re-order)</pre><br>
    {% if categories|length == 0 %}
        <span class='category-list-no-element' style="margin-left: 1em;">
            No categories exists please create one.
        </span>
    {% endif %}

    <ul id='ui-category-list'>
        {# TODO: scrollbar #}
        {% for category in categories %}
            <li id="categorylistitem-{{ category.category_id }}" {% if loop.index != 1 %} class="category-sortable" {% endif %} style="color: {{ category.color }}; {% if loop.index == 1 %}display: none;{% endif %}">
                <i class="fas fa-bars handle" aria-hidden="true" title="Drag to reorder"></i>
                <span class="categorylistitem-desc">
                    <span>{{ category.category_desc }}</span>
                    <a class="post_button" title="Edit Category Description"><i class="fas fa-edit" aria-hidden="true"></i></a>
                </span>
                <span class="categorylistitem-editdesc" style="display: none;">
                    <input type="text" placeholder="New Description of Category" maxlength="50" onkeyup="checkInputMaxLength($(this))">
                    <a class="post_button" title="Save Changes"><i class="fas fa-check" aria-hidden="true"></i></a>
                    <a class="post_button" title="Cancel Changes"><i class="fas fa-times" aria-hidden="true"></i></a>
                </span>
                <div class="float-right" style="width: auto;">
                    <select class='category-color-picker'>
                        {% for color_name, color_code in category_colors %}
                            <option value="{{ color_code }}" style="color: white;background-color: {{ color_code }};" {% if color_code == category.color %}selected="selected"{% endif %}>{{ color_name }}</option>
                        {% endfor %}
                    </select>
                    &nbsp;
                    <a class="post_button" title="Delete Category"><i class="fas fa-trash" aria-hidden="true"></i></a>
                </div>
            </li>
        {% endfor %}
    </ul>

    <script type="text/javascript">
        $(function() {

            categoriesFormEvents();

            $("#ui-category-list").find(".fa-trash").click(function() {
                var item = $(this).parent().parent().parent();
                var category_id = parseInt(item.attr('id').split("-")[1]);
                var category_desc = item.find(".categorylistitem-desc span").text().trim();
                deleteCategory(category_id, category_desc, '{{ csrf_token }}');
            });

            $("#ui-category-list").find(".fa-check").click(function() {
                var item = $(this).parent().parent().parent();
                var category_id = parseInt(item.attr('id').split("-")[1]);
                var category_desc_original = item.find(".categorylistitem-desc span").text().trim();
                var category_desc = item.find("input").val().trim();
                if(category_desc != category_desc_original) {
                    editCategory(category_id, category_desc, null, '{{ csrf_token }}');
                }
                item.find(".categorylistitem-editdesc").hide();
                item.find(".categorylistitem-desc").show();
            });

            $(".category-color-picker").change(function(color) {
                var category_id = parseInt($(this).parent().parent().attr('id').split("-")[1]);
                var category_color = $(this).val();
                editCategory(category_id, null, category_color, '{{ csrf_token }}');
                refresh_color_select($(this));
            });

        });

    </script>
{% endblock %}
{% block form %}
    {{ parent() }}
{% endblock %}
{% block buttons %}
    <a onclick="$('#ui-category-list').find('.fa-times').click();$('#category-list').css('display', 'none');" class="float-right btn btn-default close-button">Close</a>
{% endblock %}